version: "3.9"
services:
  gitlab:
    image: gitlab/gitlab-ce
    container_name: gitlab_diwa_isus
    hostname: '100.68.32.90'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://100.68.32.90:8080'
        gitlab_rails['gitlab_shell_ssh_port'] = 2222
        gitlab_rails['initial_root_password'] = "wearesame"
        nginx['listen_port'] = 80
        nginx['listen_https'] = false
    ports:
      - '8080:80'
      - '2222:22'
    volumes:
      - ./gitlab/config:/etc/gitlab
      - ./gitlab/logs:/var/log/gitlab
      - ./gitlab/data:/var/opt/gitlab
    restart: always
    networks:
      - diwa_net

  gitlab-runner:
    image: gitlab/gitlab-runner
    container_name: gitlab-runner_diwa_isus
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./runner/config:/etc/gitlab-runner
      - ./www:/var/www/html
    privileged: true
    restart: always
    networks:
      - diwa_net

  nginx:
    image: nginx:latest
    container_name: nginx_diwa
    ports:
      - '80:80'
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./www:/var/www/html
    depends_on:
      - gitlab
      - mariadb
      - nuxt
    networks:
      - diwa_net

  mariadb:
    image: mariadb:latest
    container_name: mariadb-diwa_isus
    restart: unless-stopped
    environment:
      MARIADB_ROOT_PASSWORD: wearesame
      MARIADB_DATABASE: public
      MARIADB_USER: ntdotjsx
      MARIADB_PASSWORD: wearesame
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - diwa_net

  nuxt:
    image: node:20
    container_name: nuxt_diwa
    working_dir: /var/www/html
    volumes:
      - ./www:/var/www/html
    command: ["node", ".output/server/index.mjs"]
    depends_on:
      - mariadb
    networks:
      - diwa_net

volumes:
  db_data:

networks:
  diwa_net:
    driver: bridge
