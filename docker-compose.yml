version: "3.9"
services:
  gitlab:
    image: gitlab/gitlab-ce
    container_name: gitlab_diwa_isus
    hostname: '100.68.32.90'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://100.68.32.90:8080'
        gitlab_rails['gitlab_shell_ssh_port'] = 2222
        gitlab_rails['initial_root_password'] = "wearesame"
        nginx['listen_port'] = 80
        nginx['listen_https'] = false
    ports:
      - '8080:80'
      - '2222:22'
    volumes:
      - ./gitlab/config:/etc/gitlab
      - ./gitlab/logs:/var/log/gitlab
      - ./gitlab/data:/var/opt/gitlab
    restart: always
    networks:
      - diwa_net

  gitlab-runner:
    image: gitlab/gitlab-runner
    container_name: gitlab-runner_diwa_isus
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./runner/config:/etc/gitlab-runner
      - ./www:/var/www/html
      - /home/ntdotjsx/DevOps-Lab:/home/ntdotjsx/DevOps-Lab
    privileged: true
    restart: always
    networks:
      - diwa_net

  nginx:
    image: nginx:latest
    container_name: nginx_diwa
    ports:
      - '80:80'
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./www:/var/www/html
    depends_on:
      - gitlab
      - mongo
      - nuxt
    networks:
      - diwa_net

  mongo:
    image: mongo:latest
    container_name: mongo-diwa
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: wearesame
      MONGO_INITDB_DATABASE: nuxt_auth
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - diwa_net

  nuxt:
    image: node:20
    container_name: nuxt_diwa
    working_dir: /var/www/html
    volumes:
      - ./www:/var/www/html
    command: ["node", "server/index.mjs"]
    ports:
      - "3000:3000"
    depends_on:
      - mongo
    networks:
      - diwa_net

volumes:
  mongo_data:

networks:
  diwa_net:
    driver: bridge
